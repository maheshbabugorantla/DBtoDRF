#!/usr/bin/env python
"""
Django API Test Generator
------------------------
Generates Django TestCase classes from OpenAPI specifications
with end-to-end test methods for API endpoints, including loopback tests
for complete CRUD operations.

Modified to use the OpenAPI spec generated by openapi_gen.py.
"""

import os
import json
import yaml
import ast
import astor
import argparse
import re
import traceback
from typing import Dict, List, Any, Tuple, Optional, Set, Union
from urllib.parse import urlparse
from collections import defaultdict

from drf_auto_generator.codegen import format_python_code_using_black


class OpenAPISpecHandler:
    """Handles OpenAPI specifications for test generation."""

    def __init__(self, spec: Dict[str, Any]):
        """
        Initialize with an existing OpenAPI spec dictionary.

        Args:
            spec: OpenAPI specification as a dictionary
        """
        self.spec = spec
        self.api_version = self._get_api_version()

    def _get_api_version(self) -> str:
        """Extract the OpenAPI version from the spec."""
        if 'swagger' in self.spec:
            return '2.0'  # OpenAPI 2.0 / Swagger
        elif 'openapi' in self.spec:
            return self.spec['openapi'].split('.')[0]  # OpenAPI 3.x
        else:
            raise ValueError("Unable to determine OpenAPI version")

    def get_endpoints(self) -> Dict[str, Dict]:
        """
        Extract endpoints from the OpenAPI spec.

        Returns:
            A dictionary mapping endpoint paths to their operations
        """
        return self.spec.get('paths', {})

    def get_schemas(self) -> Dict[str, Dict]:
        """
        Extract schemas/definitions from the OpenAPI spec.

        Returns:
            A dictionary mapping schema names to their definitions
        """
        if self.api_version == '2':
            return self.spec.get('definitions', {})
        elif self.api_version == '3':
            return self.spec.get('components', {}).get('schemas', {})
        else:
            raise ValueError(f"Unsupported OpenAPI version: {self.api_version}")

    def get_tags(self) -> List[Dict[str, str]]:
        """
        Get the tags defined in the OpenAPI spec.

        Returns:
            A list of tag objects with name and description
        """
        return self.spec.get('tags', [])

    def get_base_path(self) -> str:
        """Get the base path for API endpoints."""
        if self.api_version == '2':
            return self.spec.get('basePath', '')
        elif self.api_version == '3':
            servers = self.spec.get('servers', [])
            if servers and 'url' in servers[0]:
                url = urlparse(servers[0]['url'])
                return url.path
            return ''
        return ''


class EndpointAnalyzer:
    """Analyze API endpoints to identify resources and their operations."""

    def __init__(self, handler: OpenAPISpecHandler):
        """
        Initialize the analyzer with an OpenAPI spec handler.

        Args:
            handler: An initialized OpenAPISpecHandler instance
        """
        self.handler = handler
        self.endpoints = handler.get_endpoints()
        self.schemas = handler.get_schemas()
        self.base_path = handler.get_base_path()
        self.tags = handler.get_tags()

    def _normalize_path(self, path: str) -> str:
        """Normalize an API path by handling path parameters."""
        # Replace path parameters like {id} with <id>
        return re.sub(r'\{([^}]+)\}', r'<\1>', path)

    def _extract_resource_from_tag(self, tag_name: str) -> str:
        """Extract a clean resource name from a tag name."""
        # The tag name is likely to be the model/resource name directly
        return tag_name

    def identify_resources_from_tags(self) -> Dict[str, Dict]:
        """
        Group endpoints by the tags they are associated with in the OpenAPI spec.

        Returns:
            A dictionary mapping resource names to their endpoints
        """
        resources = defaultdict(dict)

        # Get tag names for easier reference
        tag_names = [tag['name'] for tag in self.tags] if self.tags else []

        # Group endpoints by tags
        for path, operations in self.endpoints.items():
            normalized_path = self._normalize_path(path)

            for method, operation in operations.items():
                if method.lower() not in ('get', 'post', 'put', 'patch', 'delete'):
                    continue

                operation_tags = operation.get('tags', [])
                operation_id = operation.get('operationId', '')

                # If operation has tags, use the first tag as the resource name
                if operation_tags and operation_tags[0] in tag_names:
                    resource_name = self._extract_resource_from_tag(operation_tags[0])
                else:
                    # Fallback to extracting from path
                    resource_name = self._extract_resource_from_path(path)

                # Store the operation using the operationId from the spec
                resources[resource_name][operation_id] = {
                    'path': normalized_path,
                    'method': method.lower(),
                    'operation': operation,
                    'parameters': operation.get('parameters', []),
                    'request_body': operation.get('requestBody', {}),
                    'tags': operation_tags,
                }

        return dict(resources)

    def _extract_resource_from_path(self, path: str) -> str:
        """
        Extract the resource name from an API path.

        Examples:
            /api/v1/users -> users
            /api/v1/users/{id} -> users
            /api/v1/users/{id}/posts -> posts
        """
        # Remove leading base path if present
        if self.base_path and path.startswith(self.base_path):
            path = path[len(self.base_path):]

        # Remove leading slash
        if path.startswith('/'):
            path = path[1:]

        # Split path into segments
        segments = path.split('/')

        # Handle empty paths
        if not segments or not segments[0]:
            return "root"

        # Handle paths with parameters
        for i, segment in enumerate(segments):
            if '{' in segment:
                # Return the previous segment as the resource name
                if i > 0:
                    return segments[i-1]

        # Default to the first segment (typically the resource name in REST APIs)
        return segments[0] if segments else "root"

    def identify_crud_groups(self) -> Dict[str, Dict]:
        """
        Identify groups of CRUD operations for each resource based on tags.

        Returns:
            A dictionary mapping resource names to their CRUD operations
        """
        resources = self.identify_resources_from_tags()
        crud_groups = {}

        # Compile patterns for matching operation IDs to CRUD types
        crud_op_patterns = {
            'list': re.compile(r'^list|^get.*s$', re.IGNORECASE),
            'retrieve': re.compile(r'^retrieve|^get.*Detail|^show', re.IGNORECASE),
            'create': re.compile(r'^create|^add|^new', re.IGNORECASE),
            'update': re.compile(r'^update|^edit', re.IGNORECASE),
            'patch': re.compile(r'^partialUpdate|^patch', re.IGNORECASE),
            'delete': re.compile(r'^delete|^remove', re.IGNORECASE),
        }

        for resource, operations in resources.items():
            crud = {
                'list': None,
                'retrieve': None,
                'create': None,
                'update': None,
                'patch': None,
                'delete': None,
            }

            # First, match by method and path pattern
            for op_id, details in operations.items():
                method = details['method']
                path = details['path']

                if method == 'get' and not re.search(r'<[^>]+>', path):
                    crud['list'] = op_id
                elif method == 'get' and re.search(r'<[^>]+>', path):
                    crud['retrieve'] = op_id
                elif method == 'post':
                    crud['create'] = op_id
                elif method == 'put':
                    crud['update'] = op_id
                elif method == 'patch':
                    crud['patch'] = op_id
                elif method == 'delete':
                    crud['delete'] = op_id

            # Then, refine using operationId patterns for better accuracy
            for op_id, details in operations.items():
                for crud_type, pattern in crud_op_patterns.items():
                    if pattern.match(op_id):
                        # Override if exact match or not assigned yet
                        if not crud[crud_type] or op_id.lower() == f"{crud_type}{resource}".lower():
                            crud[crud_type] = op_id

            # Store the CRUD mapping if at least one operation exists
            if any(crud.values()):
                crud_groups[resource] = {
                    'operations': crud,
                    'paths': {op_id: operations[op_id]['path'] for op_id in crud.values() if op_id}
                }

        return crud_groups


class SchemaAnalyzer:
    """Analyze OpenAPI schemas to generate sample data."""

    def __init__(self, handler: OpenAPISpecHandler):
        """
        Initialize the analyzer with an OpenAPI spec handler.

        Args:
            handler: An initialized OpenAPISpecHandler instance
        """
        self.handler = handler
        self.schemas = handler.get_schemas()

    def _get_reference_name(self, ref: str) -> str:
        """Extract the schema name from a $ref string."""
        if not ref.startswith('#/'):
            return ref

        # Handle OpenAPI 2.0 references
        if ref.startswith('#/definitions/'):
            return ref.replace('#/definitions/', '')

        # Handle OpenAPI 3.0 references
        if ref.startswith('#/components/schemas/'):
            return ref.replace('#/components/schemas/', '')

        return ref

    def _get_sample_value(self, schema: Dict, depth: int = 0) -> Any:
        """
        Generate a sample value based on a schema definition.

        Args:
            schema: Schema definition
            depth: Current recursion depth (to prevent infinite recursion)

        Returns:
            A sample value that conforms to the schema
        """
        if depth > 3:  # Prevent excessive recursion
            return "..."

        # Handle references
        if '$ref' in schema:
            ref_name = self._get_reference_name(schema['$ref'])
            if ref_name in self.schemas:
                return self._get_sample_value(self.schemas[ref_name], depth + 1)
            return f"<{ref_name}>"

        # Handle different types
        schema_type = schema.get('type')

        if schema_type == 'object':
            properties = schema.get('properties', {})
            sample = {}

            for prop, prop_schema in properties.items():
                # Skip readOnly properties for input data
                if prop_schema.get('readOnly', False) and depth == 0:
                    continue

                required = prop in schema.get('required', [])
                if required or depth < 2:  # Only include non-required props at shallow depth
                    sample[prop] = self._get_sample_value(prop_schema, depth + 1)

            return sample

        elif schema_type == 'array':
            items = schema.get('items', {})
            sample_item = self._get_sample_value(items, depth + 1)
            return [sample_item]

        elif schema_type == 'string':
            format_type = schema.get('format', '')
            enum_values = schema.get('enum', [])

            if enum_values:
                return enum_values[0]
            elif format_type == 'date-time':
                return "2023-01-01T00:00:00Z"
            elif format_type == 'date':
                return "2023-01-01"
            elif format_type == 'email':
                return "user@example.com"
            elif format_type == 'uuid':
                return "00000000-0000-0000-0000-000000000000"
            elif format_type == 'uri':
                return "https://example.com"
            else:
                return f"sample_{schema.get('name', 'string')}"

        elif schema_type == 'number' or schema_type == 'integer':
            return 1

        elif schema_type == 'boolean':
            return True

        elif schema_type == 'null':
            return None

        return "sample_value"

    def generate_request_data(self, operation: Dict) -> Dict:
        """
        Generate sample request data for an API operation.

        Args:
            operation: Operation details

        Returns:
            A dictionary with sample request data
        """
        api_version = self.handler.api_version
        request_data = {}

        # Handle OpenAPI 2.0
        if api_version == '2':
            body_param = next((p for p in operation.get('parameters', [])
                              if p.get('in') == 'body'), None)

            if body_param and 'schema' in body_param:
                return self._get_sample_value(body_param['schema'])

        # Handle OpenAPI 3.0
        elif api_version == '3':
            request_body = operation.get('requestBody', {})
            content = request_body.get('content', {})

            # Try application/json first
            if 'application/json' in content:
                schema = content['application/json'].get('schema', {})
                return self._get_sample_value(schema)

            # Try other content types
            for content_type, content_schema in content.items():
                schema = content_schema.get('schema', {})
                return self._get_sample_value(schema)

        return request_data

    def find_schema_for_request(self, operation: Dict) -> Optional[Dict]:
        """
        Find the schema used in a request body.

        Args:
            operation: The operation details

        Returns:
            The schema or None if not found
        """
        api_version = self.handler.api_version

        # Handle OpenAPI 2.0
        if api_version == '2':
            body_param = next((p for p in operation.get('parameters', [])
                              if p.get('in') == 'body'), None)

            if body_param and 'schema' in body_param:
                if '$ref' in body_param['schema']:
                    ref_name = self._get_reference_name(body_param['schema']['$ref'])
                    return self.schemas.get(ref_name)
                return body_param['schema']

        # Handle OpenAPI 3.0
        elif api_version == '3':
            request_body = operation.get('requestBody', {})
            content = request_body.get('content', {})

            # Try application/json first
            if 'application/json' in content:
                schema = content['application/json'].get('schema', {})
                if '$ref' in schema:
                    ref_name = self._get_reference_name(schema['$ref'])
                    return self.schemas.get(ref_name)
                return schema

            # Try other content types
            for content_type, content_schema in content.items():
                schema = content_schema.get('schema', {})
                if '$ref' in schema:
                    ref_name = self._get_reference_name(schema['$ref'])
                    return self.schemas.get(ref_name)
                return schema

        return None


class TestCaseGenerator:
    """Generate Django TestCase classes using Python AST."""

    def __init__(self, endpoint_analyzer: EndpointAnalyzer, schema_analyzer: SchemaAnalyzer, api_base: str):
        """
        Initialize the generator with analyzers.

        Args:
            endpoint_analyzer: An initialized EndpointAnalyzer instance
            schema_analyzer: An initialized SchemaAnalyzer instance
            api_base: The base URL for the API
        """
        self.endpoint_analyzer = endpoint_analyzer
        self.schema_analyzer = schema_analyzer
        self.api_base = api_base
    def _create_import_statements(self) -> List[ast.stmt]:
        """Create import statements for the test file."""
        imports = [
            # Import Django test classes
            ast.ImportFrom(
                module='django.test',
                names=[
                    ast.alias(name='TestCase', asname=None),
                ],
                level=0
            ),
            # Import status codes
            ast.ImportFrom(
                module='rest_framework',
                names=[
                    ast.alias(name='status', asname=None),
                ],
                level=0
            ),
            # Import json
            ast.Import(
                names=[
                    ast.alias(name='json', asname=None),
                ]
            ),
            # Import reverse
            ast.ImportFrom(
                module='django.urls',
                names=[
                    ast.alias(name='reverse', asname=None),
                ],
                level=0
            ),
        ]
        return imports

    def _create_setup_method(self, resource_name: str) -> ast.FunctionDef:
        """
        Create a setUp method for the test class.

        Args:
            resource_name: Name of the resource being tested

        Returns:
            An AST FunctionDef node for the setUp method
        """
        return ast.FunctionDef(
            name='setUp',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=[
                ast.Expr(
                    value=ast.Constant(
                        value=f"Set up test case for {resource_name} API tests.",
                        kind=None
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='super', ctx=ast.Load()),
                            attr='setUp',
                            ctx=ast.Load()
                        ),
                        args=[],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='client',
                            ctx=ast.Store()
                        )
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='client_class',
                            ctx=ast.Load()
                        ),
                        args=[],
                        keywords=[]
                    )
                ),
                # Add authentication setup later if needed
                ast.Assign(
                    targets=[
                        ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Store()
                        )
                    ],
                    value=ast.Constant(
                        value=self.api_base,
                        kind=None
                    )
                ),
            ],
            decorator_list=[],
            returns=None
        )

    def _create_teardown_method(self) -> ast.FunctionDef:
        """
        Create a tearDown method for the test class.

        Returns:
            An AST FunctionDef node for the tearDown method
        """
        return ast.FunctionDef(
            name='tearDown',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=[
                ast.Expr(
                    value=ast.Constant(
                        value="Clean up after tests.",
                        kind=None
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='super', ctx=ast.Load()),
                            attr='tearDown',
                            ctx=ast.Load()
                        ),
                        args=[],
                        keywords=[]
                    )
                ),
            ],
            decorator_list=[],
            returns=None
        )

    def _generate_request_data_assignment(self, resource_name: str, operation: Dict) -> ast.Assign:
        """
        Generate an assignment statement for request data.

        Args:
            resource_name: Name of the resource
            operation: Operation details

        Returns:
            An AST Assign node for request data
        """
        sample_data = self.schema_analyzer.generate_request_data(operation)

        # Convert sample data to AST Dict node
        data_node = self._dict_to_ast(sample_data)

        return ast.Assign(
            targets=[
                ast.Name(id='data', ctx=ast.Store())
            ],
            value=data_node
        )

    def _dict_to_ast(self, data: Any) -> ast.expr:
        """
        Convert a Python dictionary to an AST Dict node.

        Args:
            data: Python dictionary or other data structure

        Returns:
            An AST expression node
        """
        if isinstance(data, dict):
            keys = []
            values = []

            for key, value in data.items():
                keys.append(ast.Constant(value=key, kind=None))
                values.append(self._dict_to_ast(value))

            return ast.Dict(keys=keys, values=values)
        elif isinstance(data, (list, tuple)):
            return ast.List(
                elts=[self._dict_to_ast(item) for item in data],
                ctx=ast.Load()
            )
        else:
            return self._value_to_ast(data)

    def _value_to_ast(self, value: Any) -> ast.expr:
        """
        Convert a Python value to an AST expression node.

        Args:
            value: Python value

        Returns:
            An AST expression node
        """
        if value is None:
            return ast.Constant(value=None, kind=None)
        else:
            return ast.Constant(value=value, kind=None)

    def _find_primary_key_param(self, path: str, operation: Dict) -> Optional[str]:
        """
        Find the primary key parameter name in a path.

        Args:
            path: The path pattern
            operation: The operation definition

        Returns:
            The primary key parameter name or None
        """
        # Extract path parameters using regex
        path_params = re.findall(r'\{([^}]+)\}', path)

        if not path_params:
            return None

        # If there's only one path parameter, assume it's the primary key
        if len(path_params) == 1:
            return path_params[0]

        # Try to find a parameter that looks like an ID
        id_param = next((p for p in path_params if p.lower() in ('id', 'pk', f'{operation.get("tags", [""])[0].lower()}_id')), None)
        if id_param:
            return id_param

        # Default to the first parameter
        return path_params[0]

    def _create_test_create_method(self, resource_name: str, create_op: Dict,
                              retrieve_op: Optional[Dict] = None) -> ast.FunctionDef:
        """
        Create a test method for the create operation.

        Args:
            resource_name: Name of the resource
            create_op: Create operation details
            retrieve_op: Retrieve operation details (optional)

        Returns:
            An AST FunctionDef node for the test method
        """
        body = [
            ast.Expr(
                value=ast.Constant(
                    value=f"Test creating a {resource_name} resource.",
                    kind=None
                )
            ),
        ]

        # Add request data
        sample_data = self.schema_analyzer.generate_request_data(create_op['operation'])
        body.append(self._generate_request_data_assignment(resource_name, create_op['operation']))

        # Add POST request
        body.extend([
            ast.Assign(
                targets=[
                    ast.Name(id='url', ctx=ast.Store())
                ],
                value=ast.BinOp(
                    left=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='api_base',
                        ctx=ast.Load()
                    ),
                    op=ast.Add(),
                    right=ast.Constant(
                        value=create_op['path'].split('<')[0],  # Remove any path params
                        kind=None
                    )
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='client',
                            ctx=ast.Load()
                        ),
                        attr='post',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Name(id='url', ctx=ast.Load()),
                    ],
                    keywords=[
                        ast.keyword(
                            arg='data',
                            value=ast.Name(id='data', ctx=ast.Load())
                        ),
                        ast.keyword(
                            arg='format',
                            value=ast.Constant(value='json', kind=None)
                        )
                    ]
                )
            ),
            ast.Expr(
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='assertEqual',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='status_code',
                            ctx=ast.Load()
                        ),
                        ast.Attribute(
                            value=ast.Name(id='status', ctx=ast.Load()),
                            attr='HTTP_201_CREATED',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response_data', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='json', ctx=ast.Load()),
                        attr='loads',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='content',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
        ])

        # Find potential primary key fields - check for field named 'id' or 'pk'
        pk_field = 'id'
        body.append(
            ast.Expr(
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='assertIn',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Constant(value=pk_field, kind=None),
                        ast.Name(id='response_data', ctx=ast.Load())
                    ],
                    keywords=[]
                )
            )
        )

        body.append(
            ast.Assign(
                targets=[
                    ast.Name(id='resource_id', ctx=ast.Store())
                ],
                value=ast.Subscript(
                    value=ast.Name(id='response_data', ctx=ast.Load()),
                    slice=ast.Constant(value=pk_field, kind=None),
                    ctx=ast.Load()
                )
            )
        )

        # If retrieve operation is available, add verification
        if retrieve_op:
            # Find the primary key parameter in the retrieve path
            pk_param = self._find_primary_key_param(retrieve_op['path'], retrieve_op['operation'])
            if not pk_param:
                pk_param = 'id'  # Default if not found

            # FIX: Changed path format handling to use proper string formatting
            body.extend([
                ast.Expr(
                    value=ast.Constant(
                        value=f"Verify the {resource_name} was created correctly",
                        kind=None
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='detail_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Call(
                            func=ast.Attribute(
                                value=ast.Constant(
                                    # FIX: Use proper format pattern with braces
                                    value=retrieve_op['path'].replace(f'<{pk_param}>', '{}'),
                                    kind=None
                                ),
                                attr='format',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='resource_id', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='get_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='get',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='detail_url', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='get_response', ctx=ast.Load()),
                                attr='status_code',
                                ctx=ast.Load()
                            ),
                            ast.Attribute(
                                value=ast.Name(id='status', ctx=ast.Load()),
                                attr='HTTP_200_OK',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='get_data', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='json', ctx=ast.Load()),
                            attr='loads',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='get_response', ctx=ast.Load()),
                                attr='content',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Subscript(
                                value=ast.Name(id='get_data', ctx=ast.Load()),
                                slice=ast.Constant(value=pk_field, kind=None),
                                ctx=ast.Load()
                            ),
                            ast.Name(id='resource_id', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
            ])

            # Get the input schema to check what fields are provided
            request_schema = self.schema_analyzer.find_schema_for_request(create_op['operation'])
            if request_schema and 'properties' in request_schema:
                # Check for each field in the submitted data
                for key in request_schema['properties'].keys():
                    # Skip id, primary key, and common metadata fields
                    if key in (pk_field, 'id', 'pk', 'created_at', 'updated_at', 'created', 'modified'):
                        continue

                    # Skip any read-only properties
                    prop_schema = request_schema['properties'][key]
                    if prop_schema.get('readOnly', False):
                        continue

                    # Only include fields that were in our request data
                    if key in sample_data:
                        body.append(
                            ast.Expr(
                                value=ast.Call(
                                    func=ast.Attribute(
                                        value=ast.Name(id='self', ctx=ast.Load()),
                                        attr='assertEqual',
                                        ctx=ast.Load()
                                    ),
                                    args=[
                                        ast.Subscript(
                                            value=ast.Name(id='get_data', ctx=ast.Load()),
                                            slice=ast.Constant(value=key, kind=None),
                                            ctx=ast.Load()
                                        ),
                                        ast.Subscript(
                                            value=ast.Name(id='data', ctx=ast.Load()),
                                            slice=ast.Constant(value=key, kind=None),
                                            ctx=ast.Load()
                                        )
                                    ],
                                    keywords=[]
                                )
                            )
                        )

        return ast.FunctionDef(
            name=f'test_create_{resource_name}',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=body,
            decorator_list=[],
            returns=None
        )

    def _create_test_list_method(self, resource_name: str, list_op: Dict) -> ast.FunctionDef:
        """
        Create a test method for listing resources.

        Args:
            resource_name: Name of the resource
            list_op: List operation details

        Returns:
            An AST FunctionDef node for the test method
        """
        body = [
            ast.Expr(
                value=ast.Constant(
                    value=f"Test listing {resource_name} resources.",
                    kind=None
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='url', ctx=ast.Store())
                ],
                value=ast.BinOp(
                    left=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='api_base',
                        ctx=ast.Load()
                    ),
                    op=ast.Add(),
                    right=ast.Constant(
                        value=list_op['path'],
                        kind=None
                    )
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='client',
                            ctx=ast.Load()
                        ),
                        attr='get',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Name(id='url', ctx=ast.Load())
                    ],
                    keywords=[]
                )
            ),
            ast.Expr(
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='assertEqual',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='status_code',
                            ctx=ast.Load()
                        ),
                        ast.Attribute(
                            value=ast.Name(id='status', ctx=ast.Load()),
                            attr='HTTP_200_OK',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response_data', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='json', ctx=ast.Load()),
                        attr='loads',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='content',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
        ]

        # Check pagination structure if it exists in the API
        body.extend([
            ast.Try(
                body=[
                    ast.Expr(
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='assertIn',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Constant(value='results', kind=None),
                                ast.Name(id='response_data', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    ),
                    ast.Expr(
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='assertIsInstance',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Subscript(
                                    value=ast.Name(id='response_data', ctx=ast.Load()),
                                    slice=ast.Constant(value='results', kind=None),
                                    ctx=ast.Load()
                                ),
                                ast.Name(id='list', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    ),
                ],
                handlers=[
                    ast.ExceptHandler(
                        type=ast.Name(id='KeyError', ctx=ast.Load()),
                        name=None,
                        body=[
                            ast.Expr(
                                value=ast.Call(
                                    func=ast.Attribute(
                                        value=ast.Name(id='self', ctx=ast.Load()),
                                        attr='assertIsInstance',
                                        ctx=ast.Load()
                                    ),
                                    args=[
                                        ast.Name(id='response_data', ctx=ast.Load()),
                                        ast.Name(id='list', ctx=ast.Load())
                                    ],
                                    keywords=[]
                                )
                            ),
                        ]
                    ),
                    ast.ExceptHandler(
                        type=ast.Name(id='AssertionError', ctx=ast.Load()),
                        name=None,
                        body=[
                            ast.Expr(
                                value=ast.Call(
                                    func=ast.Attribute(
                                        value=ast.Name(id='self', ctx=ast.Load()),
                                        attr='assertIsInstance',
                                        ctx=ast.Load()
                                    ),
                                    args=[
                                        ast.Name(id='response_data', ctx=ast.Load()),
                                        ast.Name(id='list', ctx=ast.Load())
                                    ],
                                    keywords=[]
                                )
                            ),
                        ]
                    ),
                ],
                orelse=[],
                finalbody=[]
            )
        ])

        return ast.FunctionDef(
            name=f'test_list_{resource_name}',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=body,
            decorator_list=[],
            returns=None
        )

    def _create_test_retrieve_method(self, resource_name: str, retrieve_op: Dict, create_op: Optional[Dict] = None) -> ast.FunctionDef:
        """
        Create a test method for retrieving a resource.

        Args:
            resource_name: Name of the resource
            retrieve_op: Retrieve operation details
            create_op: Create operation details (optional)

        Returns:
            An AST FunctionDef node for the test method
        """
        body = [
            ast.Expr(
                value=ast.Constant(
                    value=f"Test retrieving a {resource_name} resource.",
                    kind=None
                )
            ),
        ]

        # Find the primary key parameter in the path
        pk_param = self._find_primary_key_param(retrieve_op['path'], retrieve_op['operation'])
        if not pk_param:
            pk_param = 'id'  # Default if not found

        # If create operation is available, create a resource first
        if create_op:
            body.append(
                ast.Expr(
                    value=ast.Constant(
                        value="First, create a resource to retrieve",
                        kind=None
                    )
                )
            )

            # Add request data
            body.append(self._generate_request_data_assignment(resource_name, create_op['operation']))

            # Add create request
            body.extend([
                ast.Assign(
                    targets=[
                        ast.Name(id='create_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Constant(
                            value=create_op['path'].split('<')[0],  # Remove path params
                            kind=None
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='create_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='post',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='create_url', ctx=ast.Load()),
                        ],
                        keywords=[
                            ast.keyword(
                                arg='data',
                                value=ast.Name(id='data', ctx=ast.Load())
                            ),
                            ast.keyword(
                                arg='format',
                                value=ast.Constant(value='json', kind=None)
                            )
                        ]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='created_data', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='json', ctx=ast.Load()),
                            attr='loads',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='create_response', ctx=ast.Load()),
                                attr='content',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='resource_id', ctx=ast.Store())
                    ],
                    value=ast.Subscript(
                        value=ast.Name(id='created_data', ctx=ast.Load()),
                        slice=ast.Constant(value='id', kind=None),
                        ctx=ast.Load()
                    )
                ),
            ])
        else:
            # If no create operation, assume resource with ID 1 exists
            body.append(
                ast.Assign(
                    targets=[
                        ast.Name(id='resource_id', ctx=ast.Store())
                    ],
                    value=ast.Constant(value=1, kind=None)
                )
            )

        # Add retrieve request
        # FIX: Changed path format handling to use proper string formatting
        body.extend([
            ast.Assign(
                targets=[
                    ast.Name(id='retrieve_url', ctx=ast.Store())
                ],
                value=ast.BinOp(
                    left=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='api_base',
                        ctx=ast.Load()
                    ),
                    op=ast.Add(),
                    right=ast.Call(
                        func=ast.Attribute(
                            value=ast.Constant(
                                # FIX: Use proper format pattern with braces
                                value=retrieve_op['path'].replace(f'<{pk_param}>', '{}'),
                                kind=None
                            ),
                            attr='format',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='resource_id', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='client',
                            ctx=ast.Load()
                        ),
                        attr='get',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Name(id='retrieve_url', ctx=ast.Load())
                    ],
                    keywords=[]
                )
            ),
            ast.Expr(
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='assertEqual',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='status_code',
                            ctx=ast.Load()
                        ),
                        ast.Attribute(
                            value=ast.Name(id='status', ctx=ast.Load()),
                            attr='HTTP_200_OK',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response_data', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='json', ctx=ast.Load()),
                        attr='loads',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='content',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
            ast.Expr(
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='assertEqual',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Subscript(
                            value=ast.Name(id='response_data', ctx=ast.Load()),
                            slice=ast.Constant(value='id', kind=None),
                            ctx=ast.Load()
                        ),
                        ast.Name(id='resource_id', ctx=ast.Load())
                    ],
                    keywords=[]
                )
            ),
        ])

        return ast.FunctionDef(
            name=f'test_retrieve_{resource_name}',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=body,
            decorator_list=[],
            returns=None
        )

    def _create_test_update_method(self, resource_name: str, update_op: Dict,
                            create_op: Optional[Dict] = None,
                            retrieve_op: Optional[Dict] = None) -> ast.FunctionDef:
        """
        Create a test method for updating a resource.

        Args:
            resource_name: Name of the resource
            update_op: Update operation details
            create_op: Create operation details (optional)
            retrieve_op: Retrieve operation details (optional)

        Returns:
            An AST FunctionDef node for the test method
        """
        is_patch = update_op['method'] == 'patch'
        method_name = 'patch' if is_patch else 'update'

        body = [
            ast.Expr(
                value=ast.Constant(
                    value=f"Test {method_name} a {resource_name} resource.",
                    kind=None
                )
            ),
        ]

        # Find the primary key parameter in the path
        pk_param = self._find_primary_key_param(update_op['path'], update_op['operation'])
        if not pk_param:
            pk_param = 'id'  # Default if not found

        # If create operation is available, create a resource first
        if create_op:
            body.append(
                ast.Expr(
                    value=ast.Constant(
                        value="First, create a resource to update",
                        kind=None
                    )
                )
            )

            # Add request data
            body.append(self._generate_request_data_assignment(resource_name, create_op['operation']))

            # Add create request
            body.extend([
                ast.Assign(
                    targets=[
                        ast.Name(id='create_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Constant(
                            value=create_op['path'].split('<')[0],  # Remove path params
                            kind=None
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='create_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='post',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='create_url', ctx=ast.Load()),
                        ],
                        keywords=[
                            ast.keyword(
                                arg='data',
                                value=ast.Name(id='data', ctx=ast.Load())
                            ),
                            ast.keyword(
                                arg='format',
                                value=ast.Constant(value='json', kind=None)
                            )
                        ]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='created_data', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='json', ctx=ast.Load()),
                            attr='loads',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='create_response', ctx=ast.Load()),
                                attr='content',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='resource_id', ctx=ast.Store())
                    ],
                    value=ast.Subscript(
                        value=ast.Name(id='created_data', ctx=ast.Load()),
                        slice=ast.Constant(value='id', kind=None),
                        ctx=ast.Load()
                    )
                ),
            ])
        else:
            # If no create operation, assume resource with ID 1 exists
            body.append(
                ast.Assign(
                    targets=[
                        ast.Name(id='resource_id', ctx=ast.Store())
                    ],
                    value=ast.Constant(value=1, kind=None)
                )
            )

        # Get the request schema to determine what can be modified
        request_schema = self.schema_analyzer.find_schema_for_request(update_op['operation'])
        modified_field = None

        # Create update data dictionary
        body.append(
            ast.Assign(
                targets=[
                    ast.Name(id='update_data', ctx=ast.Store())
                ],
                value=ast.Dict(
                    keys=[],
                    values=[]
                )
            )
        )

        # Find a field to modify and its value
        if request_schema and 'properties' in request_schema:
            for key, prop_schema in request_schema['properties'].items():
                # Skip id, pk, and readonly fields
                if key in ('id', 'pk') or prop_schema.get('readOnly', False):
                    continue

                # Found a field we can modify
                modified_field = key

                # Generate different values based on type
                schema_type = prop_schema.get('type', 'string')
                if schema_type == 'string':
                    modified_value = f"Updated {key} value"
                    body.append(
                        ast.Assign(
                            targets=[
                                ast.Subscript(
                                    value=ast.Name(id='update_data', ctx=ast.Load()),
                                    slice=ast.Constant(value=key, kind=None),
                                    ctx=ast.Store()
                                )
                            ],
                            value=ast.Constant(value=modified_value, kind=None)
                        )
                    )
                elif schema_type in ('integer', 'number'):
                    body.append(
                        ast.Assign(
                            targets=[
                                ast.Subscript(
                                    value=ast.Name(id='update_data', ctx=ast.Load()),
                                    slice=ast.Constant(value=key, kind=None),
                                    ctx=ast.Store()
                                )
                            ],
                            value=ast.Constant(value=42, kind=None)
                        )
                    )
                elif schema_type == 'boolean':
                    body.append(
                        ast.Assign(
                            targets=[
                                ast.Subscript(
                                    value=ast.Name(id='update_data', ctx=ast.Load()),
                                    slice=ast.Constant(value=key, kind=None),
                                    ctx=ast.Store()
                                )
                            ],
                            value=ast.Constant(value=True, kind=None)
                        )
                    )

                # We only need one field to test
                break

        # If no field could be modified, add a test field
        if not modified_field:
            modified_field = 'test_field'
            body.append(
                ast.Assign(
                    targets=[
                        ast.Subscript(
                            value=ast.Name(id='update_data', ctx=ast.Load()),
                            slice=ast.Constant(value=modified_field, kind=None),
                            ctx=ast.Store()
                        )
                    ],
                    value=ast.Constant(value='test_value', kind=None)
                )
            )

        # Add update request
        # FIX: Changed path format handling to use proper string formatting
        body.extend([
            ast.Assign(
                targets=[
                    ast.Name(id='update_url', ctx=ast.Store())
                ],
                value=ast.BinOp(
                    left=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='api_base',
                        ctx=ast.Load()
                    ),
                    op=ast.Add(),
                    right=ast.Call(
                        func=ast.Attribute(
                            value=ast.Constant(
                                # FIX: Use proper format pattern with braces
                                value=update_op['path'].replace(f'<{pk_param}>', '{}'),
                                kind=None
                            ),
                            attr='format',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='resource_id', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='client',
                            ctx=ast.Load()
                        ),
                        attr=update_op['method'],
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Name(id='update_url', ctx=ast.Load()),
                    ],
                    keywords=[
                        ast.keyword(
                            arg='data',
                            value=ast.Name(id='update_data', ctx=ast.Load())
                        ),
                        ast.keyword(
                            arg='format',
                            value=ast.Constant(value='json', kind=None)
                        )
                    ]
                )
            ),
            ast.Expr(
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='assertEqual',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='status_code',
                            ctx=ast.Load()
                        ),
                        ast.Attribute(
                            value=ast.Name(id='status', ctx=ast.Load()),
                            attr='HTTP_200_OK',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
        ])

        # If retrieve operation is available, verify the update
        if retrieve_op:
            # Find the primary key parameter in the retrieve path
            retrieve_pk_param = self._find_primary_key_param(retrieve_op['path'], retrieve_op['operation'])
            if not retrieve_pk_param:
                retrieve_pk_param = 'id'  # Default if not found

            # FIX: Changed path format handling to use proper string formatting
            body.extend([
                ast.Expr(
                    value=ast.Constant(
                        value="Verify the update with a GET request",
                        kind=None
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='retrieve_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Call(
                            func=ast.Attribute(
                                value=ast.Constant(
                                    # FIX: Use proper format pattern with braces
                                    value=retrieve_op['path'].replace(f'<{retrieve_pk_param}>', '{}'),
                                    kind=None
                                ),
                                attr='format',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='resource_id', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='get_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='get',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='retrieve_url', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='get_response', ctx=ast.Load()),
                                attr='status_code',
                                ctx=ast.Load()
                            ),
                            ast.Attribute(
                                value=ast.Name(id='status', ctx=ast.Load()),
                                attr='HTTP_200_OK',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='get_data', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='json', ctx=ast.Load()),
                            attr='loads',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='get_response', ctx=ast.Load()),
                                attr='content',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                # Verify the updated field
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Subscript(
                                value=ast.Name(id='get_data', ctx=ast.Load()),
                                slice=ast.Constant(value=modified_field, kind=None),
                                ctx=ast.Load()
                            ),
                            ast.Subscript(
                                value=ast.Name(id='update_data', ctx=ast.Load()),
                                slice=ast.Constant(value=modified_field, kind=None),
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
            ])

        return ast.FunctionDef(
            name=f'test_{method_name}_{resource_name}',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=body,
            decorator_list=[],
            returns=None
        )

    def _create_test_delete_method(self, resource_name: str, delete_op: Dict,
                            create_op: Optional[Dict] = None,
                            retrieve_op: Optional[Dict] = None) -> ast.FunctionDef:
        """
        Create a test method for deleting a resource.

        Args:
            resource_name: Name of the resource
            delete_op: Delete operation details
            create_op: Create operation details (optional)
            retrieve_op: Retrieve operation details (optional)

        Returns:
            An AST FunctionDef node for the test method
        """
        body = [
            ast.Expr(
                value=ast.Constant(
                    value=f"Test deleting a {resource_name} resource.",
                    kind=None
                )
            ),
        ]

        # Find the primary key parameter in the path
        pk_param = self._find_primary_key_param(delete_op['path'], delete_op['operation'])
        if not pk_param:
            pk_param = 'id'  # Default if not found

        # If create operation is available, create a resource first
        if create_op:
            body.append(
                ast.Expr(
                    value=ast.Constant(
                        value="First, create a resource to delete",
                        kind=None
                    )
                )
            )

            # Add request data
            body.append(self._generate_request_data_assignment(resource_name, create_op['operation']))

            # Add create request
            body.extend([
                ast.Assign(
                    targets=[
                        ast.Name(id='create_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Constant(
                            value=create_op['path'].split('<')[0],  # Remove path params
                            kind=None
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='create_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='post',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='create_url', ctx=ast.Load()),
                        ],
                        keywords=[
                            ast.keyword(
                                arg='data',
                                value=ast.Name(id='data', ctx=ast.Load())
                            ),
                            ast.keyword(
                                arg='format',
                                value=ast.Constant(value='json', kind=None)
                            )
                        ]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='created_data', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='json', ctx=ast.Load()),
                            attr='loads',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='create_response', ctx=ast.Load()),
                                attr='content',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='resource_id', ctx=ast.Store())
                    ],
                    value=ast.Subscript(
                        value=ast.Name(id='created_data', ctx=ast.Load()),
                        slice=ast.Constant(value='id', kind=None),
                        ctx=ast.Load()
                    )
                ),
            ])
        else:
            # If no create operation, assume resource with ID 1 exists
            body.append(
                ast.Assign(
                    targets=[
                        ast.Name(id='resource_id', ctx=ast.Store())
                    ],
                    value=ast.Constant(value=1, kind=None)
                )
            )

        # Add delete request
        # FIX: Changed path format handling to use proper string formatting
        body.extend([
            ast.Assign(
                targets=[
                    ast.Name(id='delete_url', ctx=ast.Store())
                ],
                value=ast.BinOp(
                    left=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='api_base',
                        ctx=ast.Load()
                    ),
                    op=ast.Add(),
                    right=ast.Call(
                        func=ast.Attribute(
                            value=ast.Constant(
                                # FIX: Use proper format pattern with braces
                                value=delete_op['path'].replace(f'<{pk_param}>', '{}'),
                                kind=None
                            ),
                            attr='format',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='resource_id', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                )
            ),
            ast.Assign(
                targets=[
                    ast.Name(id='response', ctx=ast.Store())
                ],
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='client',
                            ctx=ast.Load()
                        ),
                        attr='delete',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Name(id='delete_url', ctx=ast.Load())
                    ],
                    keywords=[]
                )
            ),
            ast.Expr(
                value=ast.Call(
                    func=ast.Attribute(
                        value=ast.Name(id='self', ctx=ast.Load()),
                        attr='assertEqual',
                        ctx=ast.Load()
                    ),
                    args=[
                        ast.Attribute(
                            value=ast.Name(id='response', ctx=ast.Load()),
                            attr='status_code',
                            ctx=ast.Load()
                        ),
                        ast.Attribute(
                            value=ast.Name(id='status', ctx=ast.Load()),
                            attr='HTTP_204_NO_CONTENT',
                            ctx=ast.Load()
                        )
                    ],
                    keywords=[]
                )
            ),
        ])

        # If retrieve operation is available, verify the deletion
        if retrieve_op:
            # Find the primary key parameter in the retrieve path
            retrieve_pk_param = self._find_primary_key_param(retrieve_op['path'], retrieve_op['operation'])
            if not retrieve_pk_param:
                retrieve_pk_param = 'id'  # Default if not found

            # FIX: Changed path format handling to use proper string formatting
            body.extend([
                ast.Expr(
                    value=ast.Constant(
                        value="Verify the resource was deleted",
                        kind=None
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='retrieve_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Call(
                            func=ast.Attribute(
                                value=ast.Constant(
                                    # FIX: Use proper format pattern with braces
                                    value=retrieve_op['path'].replace(f'<{retrieve_pk_param}>', '{}'),
                                    kind=None
                                ),
                                attr='format',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='resource_id', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='get_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='get',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='retrieve_url', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='get_response', ctx=ast.Load()),
                                attr='status_code',
                                ctx=ast.Load()
                            ),
                            ast.Attribute(
                                value=ast.Name(id='status', ctx=ast.Load()),
                                attr='HTTP_404_NOT_FOUND',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
            ])

        return ast.FunctionDef(
            name=f'test_delete_{resource_name}',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=body,
            decorator_list=[],
            returns=None
        )

    def _create_test_crud_method(self, resource_name: str, crud_ops: Dict) -> Optional[ast.FunctionDef]:
        """
        Create a test method for a complete CRUD cycle.

        Args:
            resource_name: Name of the resource
            crud_ops: CRUD operations dictionary

        Returns:
            An AST FunctionDef node for the test method or None if essential operations are missing
        """
        operations = crud_ops['operations']
        paths = crud_ops['paths']

        create_op_id = operations['create']
        retrieve_op_id = operations['retrieve']
        update_op_id = operations['update'] or operations['patch']
        delete_op_id = operations['delete']

        # Skip if essential operations are missing
        if not create_op_id or not retrieve_op_id:
            return None

        body = [
            ast.Expr(
                value=ast.Constant(
                    value=f"Test the complete CRUD cycle for {resource_name} resource.",
                    kind=None
                )
            ),
            ast.Expr(
                value=ast.Constant(
                    value="1. Create a resource",
                    kind=None
                )
            ),
        ]

        resources = self.endpoint_analyzer.identify_resources_from_tags()
        resource_ops = resources.get(resource_name, {})

        # Add request data for create operation
        if create_op_id and create_op_id in resource_ops:
            create_op = resource_ops[create_op_id]
            body.append(self._generate_request_data_assignment(resource_name, create_op['operation']))

            # Add create request
            body.extend([
                ast.Assign(
                    targets=[
                        ast.Name(id='create_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Constant(
                            value=create_op['path'].split('<')[0],  # Remove path params
                            kind=None
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='create_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='post',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='create_url', ctx=ast.Load()),
                        ],
                        keywords=[
                            ast.keyword(
                                arg='data',
                                value=ast.Name(id='data', ctx=ast.Load())
                            ),
                            ast.keyword(
                                arg='format',
                                value=ast.Constant(value='json', kind=None)
                            )
                        ]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='create_response', ctx=ast.Load()),
                                attr='status_code',
                                ctx=ast.Load()
                            ),
                            ast.Attribute(
                                value=ast.Name(id='status', ctx=ast.Load()),
                                attr='HTTP_201_CREATED',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='created_data', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='json', ctx=ast.Load()),
                            attr='loads',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='create_response', ctx=ast.Load()),
                                attr='content',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertIn',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Constant(value='id', kind=None),
                            ast.Name(id='created_data', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='resource_id', ctx=ast.Store())
                    ],
                    value=ast.Subscript(
                        value=ast.Name(id='created_data', ctx=ast.Load()),
                        slice=ast.Constant(value='id', kind=None),
                        ctx=ast.Load()
                    )
                ),
            ])

        # 2. Retrieve and verify the resource
        if retrieve_op_id and retrieve_op_id in resource_ops:
            retrieve_op = resource_ops[retrieve_op_id]

            # Find the primary key parameter in the retrieve path
            pk_param = self._find_primary_key_param(retrieve_op['path'], retrieve_op['operation'])
            if not pk_param:
                pk_param = 'id'  # Default if not found

            # FIX: Changed path format handling to use proper string formatting
            body.extend([
                ast.Expr(
                    value=ast.Constant(
                        value="2. Retrieve the created resource",
                        kind=None
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='retrieve_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Call(
                            func=ast.Attribute(
                                value=ast.Constant(
                                    # FIX: Use proper format pattern with braces
                                    value=retrieve_op['path'].replace(f'<{pk_param}>', '{}'),
                                    kind=None
                                ),
                                attr='format',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='resource_id', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='retrieve_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='get',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='retrieve_url', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='retrieve_response', ctx=ast.Load()),
                                attr='status_code',
                                ctx=ast.Load()
                            ),
                            ast.Attribute(
                                value=ast.Name(id='status', ctx=ast.Load()),
                                attr='HTTP_200_OK',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='retrieved_data', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='json', ctx=ast.Load()),
                            attr='loads',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='retrieve_response', ctx=ast.Load()),
                                attr='content',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Subscript(
                                value=ast.Name(id='retrieved_data', ctx=ast.Load()),
                                slice=ast.Constant(value='id', kind=None),
                                ctx=ast.Load()
                            ),
                            ast.Name(id='resource_id', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
            ])

        # 3. Update the resource
        if update_op_id and update_op_id in resource_ops:
            update_op = resource_ops[update_op_id]
            update_method = update_op['method']

            # Find the primary key parameter in the update path
            pk_param = self._find_primary_key_param(update_op['path'], update_op['operation'])
            if not pk_param:
                pk_param = 'id'  # Default if not found

            body.extend([
                ast.Expr(
                    value=ast.Constant(
                        value=f"3. Update the resource using {update_method.upper()}",
                        kind=None
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='update_data', ctx=ast.Store())
                    ],
                    value=ast.Dict(
                        keys=[],
                        values=[]
                    )
                ),
            ])

            # Modify one field for update
            sample_data = self.schema_analyzer.generate_request_data(update_op['operation'])
            modified_field = None

            for key in sample_data.keys():
                if key not in ('id', 'pk') and not key.startswith('created_') and not key.startswith('updated_'):
                    modified_field = key
                    # Modified value based on type
                    if isinstance(sample_data[key], str):
                        body.append(
                            ast.Assign(
                                targets=[
                                    ast.Subscript(
                                        value=ast.Name(id='update_data', ctx=ast.Load()),
                                        slice=ast.Constant(value=key, kind=None),
                                        ctx=ast.Store()
                                    )
                                ],
                                value=ast.Constant(value=f"Updated {key} value", kind=None)
                            )
                        )
                    elif isinstance(sample_data[key], (int, float)):
                        body.append(
                            ast.Assign(
                                targets=[
                                    ast.Subscript(
                                        value=ast.Name(id='update_data', ctx=ast.Load()),
                                        slice=ast.Constant(value=key, kind=None),
                                        ctx=ast.Store()
                                    )
                                ],
                                value=ast.Constant(value=42, kind=None)
                            )
                        )
                    elif isinstance(sample_data[key], bool):
                        body.append(
                            ast.Assign(
                                targets=[
                                    ast.Subscript(
                                        value=ast.Name(id='update_data', ctx=ast.Load()),
                                        slice=ast.Constant(value=key, kind=None),
                                        ctx=ast.Store()
                                    )
                                ],
                                value=ast.Constant(value=not sample_data[key], kind=None)
                            )
                        )
                    # Break after finding the first suitable field
                    break

            # If no field could be modified, add a test field
            if not modified_field:
                modified_field = 'test_field'
                body.append(
                    ast.Assign(
                        targets=[
                            ast.Subscript(
                                value=ast.Name(id='update_data', ctx=ast.Load()),
                                slice=ast.Constant(value=modified_field, kind=None),
                                ctx=ast.Store()
                            )
                        ],
                        value=ast.Constant(value='test_value', kind=None)
                    )
                )

            # FIX: Changed path format handling to use proper string formatting
            body.extend([
                ast.Assign(
                    targets=[
                        ast.Name(id='update_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Call(
                            func=ast.Attribute(
                                value=ast.Constant(
                                    # FIX: Use proper format pattern with braces
                                    value=update_op['path'].replace(f'<{pk_param}>', '{}'),
                                    kind=None
                                ),
                                attr='format',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='resource_id', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='update_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr=update_method,
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='update_url', ctx=ast.Load()),
                        ],
                        keywords=[
                            ast.keyword(
                                arg='data',
                                value=ast.Name(id='update_data', ctx=ast.Load())
                            ),
                            ast.keyword(
                                arg='format',
                                value=ast.Constant(value='json', kind=None)
                            )
                        ]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='update_response', ctx=ast.Load()),
                                attr='status_code',
                                ctx=ast.Load()
                            ),
                            ast.Attribute(
                                value=ast.Name(id='status', ctx=ast.Load()),
                                attr='HTTP_200_OK',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
            ])

            # Verify update with a GET request
            if retrieve_op_id and retrieve_op_id in resource_ops:
                body.extend([
                    ast.Expr(
                        value=ast.Constant(
                            value="Verify the update with a GET request",
                            kind=None
                        )
                    ),
                    ast.Assign(
                        targets=[
                            ast.Name(id='verify_response', ctx=ast.Store())
                        ],
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Attribute(
                                    value=ast.Name(id='self', ctx=ast.Load()),
                                    attr='client',
                                    ctx=ast.Load()
                                ),
                                attr='get',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='retrieve_url', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    ),
                    ast.Expr(
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='assertEqual',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Attribute(
                                    value=ast.Name(id='verify_response', ctx=ast.Load()),
                                    attr='status_code',
                                    ctx=ast.Load()
                                ),
                                ast.Attribute(
                                    value=ast.Name(id='status', ctx=ast.Load()),
                                    attr='HTTP_200_OK',
                                    ctx=ast.Load()
                                )
                            ],
                            keywords=[]
                        )
                    ),
                    ast.Assign(
                        targets=[
                            ast.Name(id='verified_data', ctx=ast.Store())
                        ],
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Name(id='json', ctx=ast.Load()),
                                attr='loads',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Attribute(
                                    value=ast.Name(id='verify_response', ctx=ast.Load()),
                                    attr='content',
                                    ctx=ast.Load()
                                )
                            ],
                            keywords=[]
                        )
                    ),
                    ast.Expr(
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='assertEqual',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Subscript(
                                    value=ast.Name(id='verified_data', ctx=ast.Load()),
                                    slice=ast.Constant(value=modified_field, kind=None),
                                    ctx=ast.Load()
                                ),
                                ast.Subscript(
                                    value=ast.Name(id='update_data', ctx=ast.Load()),
                                    slice=ast.Constant(value=modified_field, kind=None),
                                    ctx=ast.Load()
                                )
                            ],
                            keywords=[]
                        )
                    ),
                ])

        # 4. Delete the resource
        if delete_op_id and delete_op_id in resource_ops:
            delete_op = resource_ops[delete_op_id]

            # Find the primary key parameter in the delete path
            pk_param = self._find_primary_key_param(delete_op['path'], delete_op['operation'])
            if not pk_param:
                pk_param = 'id'  # Default if not found

            # FIX: Changed path format handling to use proper string formatting
            body.extend([
                ast.Expr(
                    value=ast.Constant(
                        value="4. Delete the resource",
                        kind=None
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='delete_url', ctx=ast.Store())
                    ],
                    value=ast.BinOp(
                        left=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='api_base',
                            ctx=ast.Load()
                        ),
                        op=ast.Add(),
                        right=ast.Call(
                            func=ast.Attribute(
                                value=ast.Constant(
                                    # FIX: Use proper format pattern with braces
                                    value=delete_op['path'].replace(f'<{pk_param}>', '{}'),
                                    kind=None
                                ),
                                attr='format',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='resource_id', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    )
                ),
                ast.Assign(
                    targets=[
                        ast.Name(id='delete_response', ctx=ast.Store())
                    ],
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='client',
                                ctx=ast.Load()
                            ),
                            attr='delete',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Name(id='delete_url', ctx=ast.Load())
                        ],
                        keywords=[]
                    )
                ),
                ast.Expr(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='self', ctx=ast.Load()),
                            attr='assertEqual',
                            ctx=ast.Load()
                        ),
                        args=[
                            ast.Attribute(
                                value=ast.Name(id='delete_response', ctx=ast.Load()),
                                attr='status_code',
                                ctx=ast.Load()
                            ),
                            ast.Attribute(
                                value=ast.Name(id='status', ctx=ast.Load()),
                                attr='HTTP_204_NO_CONTENT',
                                ctx=ast.Load()
                            )
                        ],
                        keywords=[]
                    )
                ),
            ])

            # Verify deletion if retrieve operation exists
            if retrieve_op_id and retrieve_op_id in resource_ops:
                body.extend([
                    ast.Expr(
                        value=ast.Constant(
                            value="Verify the resource was deleted",
                            kind=None
                        )
                    ),
                    ast.Assign(
                        targets=[
                            ast.Name(id='verify_delete_response', ctx=ast.Store())
                        ],
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Attribute(
                                    value=ast.Name(id='self', ctx=ast.Load()),
                                    attr='client',
                                    ctx=ast.Load()
                                ),
                                attr='get',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Name(id='retrieve_url', ctx=ast.Load())
                            ],
                            keywords=[]
                        )
                    ),
                    ast.Expr(
                        value=ast.Call(
                            func=ast.Attribute(
                                value=ast.Name(id='self', ctx=ast.Load()),
                                attr='assertEqual',
                                ctx=ast.Load()
                            ),
                            args=[
                                ast.Attribute(
                                    value=ast.Name(id='verify_delete_response', ctx=ast.Load()),
                                    attr='status_code',
                                    ctx=ast.Load()
                                ),
                                ast.Attribute(
                                    value=ast.Name(id='status', ctx=ast.Load()),
                                    attr='HTTP_404_NOT_FOUND',
                                    ctx=ast.Load()
                                )
                            ],
                            keywords=[]
                        )
                    ),
                ])

        return ast.FunctionDef(
            name=f'test_{resource_name}_crud_cycle',
            args=ast.arguments(
                posonlyargs=[],
                args=[ast.arg(arg='self', annotation=None)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[],
                vararg=None,
                kwarg=None
            ),
            body=body,
            decorator_list=[],
            returns=None
        )

    def generate_testcase_class(self, resource_name: str, crud_ops: Dict) -> ast.ClassDef:
        """
        Generate a test case class for a resource.

        Args:
            resource_name: Name of the resource
            crud_ops: CRUD operations for the resource

        Returns:
            An AST ClassDef node for the test case class
        """
        operations = crud_ops['operations']

        # Create class body with setup and teardown methods
        body = [
            self._create_setup_method(resource_name),
            self._create_teardown_method()
        ]

        # Add individual test methods for each operation
        resources = self.endpoint_analyzer.identify_resources_from_tags()
        resource_ops = resources.get(resource_name, {})

        # Add CRUD cycle test first (if applicable)
        crud_test = self._create_test_crud_method(resource_name, crud_ops)
        if crud_test:
            body.append(crud_test)

        # Add individual operation tests
        if operations['list'] and operations['list'] in resource_ops:
            op_details = resource_ops[operations['list']]
            body.append(self._create_test_list_method(resource_name, op_details))

        if operations['create'] and operations['create'] in resource_ops:
            op_details = resource_ops[operations['create']]
            retrieve_op = resource_ops.get(operations['retrieve']) if operations['retrieve'] else None
            body.append(self._create_test_create_method(resource_name, op_details, retrieve_op))

        if operations['retrieve'] and operations['retrieve'] in resource_ops:
            op_details = resource_ops[operations['retrieve']]
            create_op = resource_ops.get(operations['create']) if operations['create'] else None
            body.append(self._create_test_retrieve_method(resource_name, op_details, create_op))

        if operations['update'] and operations['update'] in resource_ops:
            op_details = resource_ops[operations['update']]
            create_op = resource_ops.get(operations['create']) if operations['create'] else None
            retrieve_op = resource_ops.get(operations['retrieve']) if operations['retrieve'] else None
            body.append(self._create_test_update_method(resource_name, op_details, create_op, retrieve_op))

        if operations['patch'] and operations['patch'] in resource_ops:
            op_details = resource_ops[operations['patch']]
            create_op = resource_ops.get(operations['create']) if operations['create'] else None
            retrieve_op = resource_ops.get(operations['retrieve']) if operations['retrieve'] else None
            body.append(self._create_test_update_method(resource_name, op_details, create_op, retrieve_op))

        if operations['delete'] and operations['delete'] in resource_ops:
            op_details = resource_ops[operations['delete']]
            create_op = resource_ops.get(operations['create']) if operations['create'] else None
            retrieve_op = resource_ops.get(operations['retrieve']) if operations['retrieve'] else None
            body.append(self._create_test_delete_method(resource_name, op_details, create_op, retrieve_op))

        # Create the class definition
        return ast.ClassDef(
            name=f'{resource_name.title()}ApiTests',
            bases=[
                ast.Name(id='TestCase', ctx=ast.Load())
            ],
            keywords=[],
            body=body,
            decorator_list=[]
        )

    def generate_test_file(self, output_path: Optional[str] = None) -> str:
        """
        Generate a complete test file with test cases for all identified resources.

        Args:
            output_path: Path to write the generated code (optional)

        Returns:
            The generated Python code as a string
        """
        # Create the AST module
        module = ast.Module(
            body=self._create_import_statements(),
            type_ignores=[]
        )

        # Add test classes for each resource
        crud_groups = self.endpoint_analyzer.identify_crud_groups()

        for resource_name, crud_ops in crud_groups.items():
            test_class = self.generate_testcase_class(resource_name, crud_ops)
            module.body.append(test_class)

        # Generate code from the AST
        code = astor.to_source(module)

        # Write to file if path is provided
        if output_path:
            with open(output_path, 'w') as f:
                f.write(format_python_code_using_black(output_path, code))

        return code


def main():
    """Main entry point for the command-line tool."""
    parser = argparse.ArgumentParser(
        description="Generate Django API tests from an OpenAPI specification."
    )
    parser.add_argument(
        "spec_path",
        help="Path to the OpenAPI specification file (.json or .yaml)"
    )
    parser.add_argument(
        "-o", "--output",
        help="Output path for the generated test file",
        default="tests_api.py"
    )
    parser.add_argument(
        "--api-base",
        help="Base path for API endpoints",
        default=""  # Empty string for now, customizable
    )
    parser.add_argument(
        "--use-existing",
        action="store_true",
        help="Use an existing OpenAPI spec file instead of parsing it anew"
    )

    args = parser.parse_args()

    try:
        # Load the OpenAPI spec
        print(f"Reading OpenAPI specification from {args.spec_path}")
        with open(args.spec_path, 'r') as f:
            if args.spec_path.endswith('.json'):
                spec_dict = json.load(f)
            elif args.spec_path.endswith(('.yaml', '.yml')):
                spec_dict = yaml.safe_load(f)
            else:
                raise ValueError(f"Unsupported file format: {args.spec_path}. Use .json, .yaml, or .yml")

        # Initialize the handler with the spec dictionary
        print("Initializing OpenAPI spec handler")
        handler = OpenAPISpecHandler(spec_dict)

        # Initialize analyzers
        print("Setting up endpoint and schema analyzers")
        endpoint_analyzer = EndpointAnalyzer(handler)
        schema_analyzer = SchemaAnalyzer(handler)

        # Generate tests
        print("Generating test classes")
        test_generator = TestCaseGenerator(endpoint_analyzer, schema_analyzer, args.api_base)
        code = test_generator.generate_test_file(args.output)

        print(f"Successfully generated API tests in {args.output}")

        # Summary of resources
        crud_groups = endpoint_analyzer.identify_crud_groups()
        print(f"\nGenerated tests for {len(crud_groups)} resources:")

        for resource, ops in crud_groups.items():
            available_ops = [op for op, value in ops['operations'].items() if value]
            print(f"  - {resource}: {', '.join(available_ops)}")

    except FileNotFoundError:
        print(f"Error: Could not find the OpenAPI specification file at {args.spec_path}")
        return 1
    except Exception as e:
        print(f"Error: {str(e)}")
        traceback.print_exc()
        return 1

    return 0

if __name__ == "__main__":
    import sys
    sys.exit(main())
